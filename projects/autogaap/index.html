<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="../../styles/global.css">
<link rel="stylesheet" href="../../styles/neon.css">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
			<title>autoGAAP - Accounting Made Easy</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.min.js"></script>
<!-- Core app and shared utilities -->
<script src="../../scripts/base_app.js"></script>
<script src="../../scripts/global.js"></script>

<!-- Functional modules -->
<script src="../../scripts/journal.js"></script>
<script src="../../scripts/balance.js"></script>
<script src="../../scripts/depreciation.js"></script>
<script src="../../scripts/recurring.js"></script>
<script src="../../scripts/export.js"></script>
<script src="../../scripts/chart.js"></script>
<script src="../../scripts/gaap_expansion.js"></script>
<script src="../../scripts/geo_location.js"></script>

<!-- Main orchestrator -->
<script src="../../scripts/main.js"></script>

<!-- AutoGAAP logic -->
<script src="../../scripts/autogaap.js"></script>
		
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">

/* Dialog layer */
#gaap-dialog {
z-index: 9999 !important;
}
</style>
</head>
	<body>
		<div class="container">
			<div class="form-container">
				<div class="form-column">
					<h2>Journal Entry Form</h2>

				<div class="form-group">
					<button onclick="loadLedgerJson()">üîÅ Load Ledger JSON</button>
				</div>
					<form id="journalForm">
						<div class="form-group">
							<label for="postDate">Post Date:</label>
							<input type="date" id="postDate" required />
						</div>

						<div class="form-group">
							<label for="description">Description:</label>
							<textarea id="description" rows="2" required></textarea>
						</div>
						<div class="form-group">
							<label>Account 1:</label>
							<select id="account1Type" required>
								<option value="">Select Account Type</option>
								<option value="asset">Asset</option>
								<option value="liability">Liability</option>
								<option value="revenue">Revenue</option>
								<option value="expense">Expense</option>
							</select>
							<select id="account1SubType" required>
								<option value="">Select Sub-category</option>
								<option value="current">Current</option>
								<option value="non-current">Non-Current</option>
							</select>
								<input type="text" id="account1Name" placeholder="Account Name" required />
								<input type="number" id="debitAmount1" placeholder="Debit Amount" min="0" />
								<input type="number" id="creditAmount1" placeholder="Credit Amount" min="0" />

							<div class="checkbox-group">
								<label for="apply-depreciation">
								<input type="checkbox" id="apply-depreciation" />
									Apply Depreciation
								</label>
							</div>
							<div id="asset-details" style="display: none;">
								<label for="asset-name">Asset Name:</label>
								<input type="text" id="asset-name" /><br />
								<label for="asset-value">Asset Value:</label>
								<input type="number" id="asset-value" /><br />
								<label for="useful-life">Useful Life (in years):</label>
								<input type="number" id="useful-life" /><br />
							</div>
						</div>

						<div class="form-group">
							<label>Account 2:</label>
							<select id="account2Type" required>
								<option value="">Select Account Type</option>
								<option value="asset">Asset</option>
								<option value="liability">Liability</option>
								<option value="revenue">Revenue</option>
								<option value="expense">Expense</option>
							</select>
							<select id="account2SubType" required>
								<option value="">Select Sub-category</option>
								<option value="current">Current</option>
								<option value="non-current">Non-Current</option>
							</select>
								<input type="text" id="account2Name" placeholder="Account Name" required />
								<input type="number" id="debitAmount2" placeholder="Debit Amount" min="0" />
								<input type="number" id="creditAmount2" placeholder="Credit Amount" min="0" />
							</div>

						<div class="checkbox-group">
							<label><input type="checkbox" id="isAccrued" /> Accrued</label>
							<label><input type="checkbox" id="isPrepaid" /> Prepaid</label>
						</div>

						<div id="accrual-details" style="display: none;">
							<label for="accrued-due-date">Due Date:</label>
							<input type="date" id="accrued-due-date" /><br />
							<label for="accrued-account">Recognition Account:</label>
							<input type="text" id="accrued-account" /><br />
							<label for="accrued-period">Recognition Period:</label>
							<input type="text" id="accrued-period" /><br />
						</div>

						<div id="prepaid-details" style="display: none;">
							<label for="prepaid-start-date">Start Date:</label>
							<input type="date" id="prepaid-start-date" /><br />
							<label for="prepaid-end-date">End Date:</label>
							<input type="date" id="prepaid-end-date" /><br />
							<label for="prepaid-account">Amortization Account:</label>
							<input type="text" id="prepaid-account" /><br />
						</div>

						
<div class="form-group" style="display: flex; gap: 10px;">
  <button type="submit">Add Entry</button>
  <button type="button" onclick="runAutoGAAP()">üìò Check GAAP</button>
</div>

					</form>
				</div> <!-- close form-column -->

								
				<div class="instructions-container">
					<h3>üìò How to Journalize (Paper Examples)</h3>
						<pre style="font-family: 'Fira Code', monospace; font-size: 0.85em;">
							Vehicle .................... Dr. $18,000
							Cash ............................. Cr. $15,000
							Loan Payable .................... Cr. $3,000
							(Purchase with partial cash & loan)

							Depreciation Expense .... Dr. $300
							Accum. Depreciation ....... Cr. $300
							(Monthly depreciation)

							Prepaid Insurance ........... Dr. $600
							Cash ............................. Cr. $600
							(Six month policy prepaid)

							Insurance Expense .......... Dr. $100
							Prepaid Insurance ............ Cr. $100
							(Recognize 1 month used)

							Wages Expense ................ Dr. $500
							Wages Payable .................. Cr. $500
							(Accrued payroll owed)
						</pre>

					<h3>üìò ALCDRE Rules</h3>
						<ul style="padding-left: 1em; font-size: 0.85em;">
							<li><strong>A</strong>ssets ‚Äì Debit to increase</li>
							<li><strong>L</strong>iabilities ‚Äì Credit to increase</li>
							<li><strong>C</strong>apital ‚Äì Credit to increase</li>
							<li><strong>D</strong>rawing ‚Äì Debit to increase</li>
							<li><strong>R</strong>evenue ‚Äì Credit to increase</li>
							<li><strong>E</strong>xpense ‚Äì Debit to increase</li>
						</ul>

				<h3>üìò Accounting Equation</h3>
					<p style="font-size: 0.85em;">Assets = Liabilities + Owner's Equity</p>

				<h3>üìò Contra Accounts</h3>
					<p style="font-size: 0.85em;">
				A contra account offsets the balance of a related account:
				<br/>e.g. Accumulated Depreciation offsets Equipment.
					</p>

				</div> <!-- end instructions-container -->
			</div> <!-- end form-container -->

			<div class="export-buttons">
				<button onclick="generateBalanceSheet()">Balance Sheet (PDF)</button>
				<button onclick="generateIncomeStatement()">Income Statement (PDF)</button>
				<button onclick="generateCashFlowStatement()">Cash Flow (PDF)</button>
				<button onclick="generateOwnersEquity()">Owner‚Äôs Equity (PDF)</button>
			</div>

	<h3>Journal Entries</h3>
		<div id="journalEntries"></div>

			<div class="export-buttons">
				<button onclick="exportToPDF()">Export to PDF</button>
				<button onclick="exportToJson()">Export to JSON</button>
				<button onclick="clearJournal()">Clear</button>
			</div>

		</div> <!-- end .container -->

		<div class="chart-section">
			<div id="balanceIndicator" class="balance-indicator unbalanced">
				‚ö†Ô∏è Unbalanced
		</div>

		<div class="chart-container">
			<canvas id="accountBalanceChart"></canvas>
		</div>
	</div>
</body>

<script>
const { jsPDF } = window.jspdf;

let journalEntries = JSON.parse(localStorage.getItem("journalEntries")) || [];

const ctx = document.getElementById("accountBalanceChart").getContext("2d");
const accountBalanceChart = new Chart(ctx, {
	type: "bar",
	data: {
		labels: ["Asset", "Liability", "Equity", "Revenue", "Expense"],
		datasets: [
			{
				label: "Debit",
				data: [0, 0, 0, 0, 0],
				backgroundColor: "#28a745"
			},
			{
				label: "Credit",
				data: [0, 0, 0, 0, 0],
				backgroundColor: "#dc3545"
			}
		]
	},
	options: {
		scales: {
			y: { beginAtZero: true }
		}
	}
});

function generateJournalNumber(account1, account2) {
	const timestamp = Date.now();
	return `CPU-${account1}-${account2}-${timestamp}`.replace(/\s+/g, '');
}

function updateBalanceStatus() {
	let debits = 0, credits = 0;
	let byType = {
		asset: { debit: 0, credit: 0 },
		liability: { debit: 0, credit: 0 },
		equity: { debit: 0, credit: 0 },
		revenue: { debit: 0, credit: 0 },
		expense: { debit: 0, credit: 0 }
	};
	
	journalEntries.forEach(entry => {
		entry.entries.forEach(tx => {
			if (!byType[tx.accountType]) return;
			byType[tx.accountType].debit += tx.debit;
			byType[tx.accountType].credit += tx.credit;
			debits += tx.debit;
			credits += tx.credit;
		});
	});
	
	const ind = document.getElementById("balanceIndicator");
	ind.innerText = (debits === credits) ? "‚úÖ Balanced" : "‚ö†Ô∏è Unbalanced";
	ind.classList.toggle("balanced", debits === credits);
	ind.classList.toggle("unbalanced", debits !== credits);
	
	accountBalanceChart.data.datasets[0].data = [
		byType.asset.debit, byType.liability.debit, byType.equity.debit,
		byType.revenue.debit, byType.expense.debit
	];
	accountBalanceChart.data.datasets[1].data = [
		byType.asset.credit, byType.liability.credit, byType.equity.credit,
		byType.revenue.credit, byType.expense.credit
	];
	accountBalanceChart.update();
}

function displayJournalEntries() {
	const container = document.getElementById("journalEntries");
	container.innerHTML = "";
	
	journalEntries.forEach(entry => {
		const div = document.createElement("div");
		div.className = "journal-entry";
		let html = `
		<strong>Entry Number: ${entry.journalNumber}</strong><br>
		<strong>Date:</strong> ${entry.postDate}<br>
		<strong>Description:</strong> ${entry.description}<br><br>
		<table>
		<tr><td><strong>Account</strong></td><td><strong>Debit</strong></td><td><strong>Credit</strong></td></tr>
		`;
		entry.entries.forEach(tx => {
			html += `
			<tr>
			<td>${tx.accountName}</td>
			<td>${tx.debit > 0 ? "$" + tx.debit.toFixed(2) : ""}</td>
			<td>${tx.credit > 0 ? "$" + tx.credit.toFixed(2) : ""}</td>
			</tr>
			`;
		});
		html += `</table><hr>`;
		div.innerHTML = html;
		container.appendChild(div);
	});
}

function clearJournal() {
	if (confirm("Are you sure you want to clear all journal entries?")) {
		journalEntries = [];
		localStorage.removeItem("journalEntries");
		displayJournalEntries();
		updateBalanceStatus();
	}
}

window.onload = () => {
	displayJournalEntries();
	updateBalanceStatus();
};
</script>
<script>
function loadLedgerJson() {
	const input = document.createElement("input");
	input.type = "file";
	input.accept = "application/json";
	input.onchange = e => {
		const file = e.target.files[0];
		const reader = new FileReader();
		reader.onload = () => {
			try {
				journalEntries = JSON.parse(reader.result);
				localStorage.setItem("journalEntries", JSON.stringify(journalEntries));
				displayJournalEntries();
				updateBalanceStatus();
			} catch {
				alert("Invalid JSON file.");
			}
		};
		reader.readAsText(file);
	};
	input.click();
}

function exportToPDF() {
	const doc = new jsPDF();
	doc.setFontSize(12);
	doc.text("Journal Entries", 10, 10);
	let y = 20;
	
	journalEntries.forEach(entry => {
		doc.text(`Entry #: ${entry.journalNumber}`, 10, y); y += 5;
		doc.text(`Date: ${entry.postDate}`, 10, y); y += 5;
		doc.text(`Desc: ${entry.description}`, 10, y); y += 10;
		
		entry.entries.forEach(tx => {
			doc.text(`${tx.accountName}`, 10, y);
			doc.text(`D: $${tx.debit.toFixed(2)} C: $${tx.credit.toFixed(2)}`, 80, y);
			y += 8;
		});
		y += 10;
	});
	
	doc.save("journal_entries.pdf");
}

function exportToJson() {
	const blob = new Blob([JSON.stringify(journalEntries, null, 2)], { type: "application/json" });
	const a = document.createElement("a");
	a.href = URL.createObjectURL(blob);
	a.download = "journal-entries.json";
	a.click();
}

function generateBalanceSheet() {
	const doc = new jsPDF();
	doc.setFontSize(12);
  	doc.text("Balance Sheet", 10, 10);

    const assets = [];
	const expenses = [];
	let totalAssets = 0;
    let totalExpenses = 0;

    journalEntries.forEach(entry => {
  		entry.entries.forEach(tx => {
        	if (tx.accountType === "asset" && tx.debit > 0) {
	        assets.push({ name: tx.accountName, amount: tx.debit });
    	    totalAssets += tx.debit;
	        }
        	if (tx.accountType === "expense" && tx.debit > 0) {
	        expenses.push({ name: tx.accountName, amount: tx.debit });
    	    totalExpenses += tx.debit;
        }
  	    });
    });

    let y = 20;
    doc.text("ASSETS", 10, y);
    doc.text("AMOUNT", 60, y);
    doc.text("EXPENSES", 110, y);
    doc.text("AMOUNT", 160, y);
    y += 8;

    const maxRows = Math.max(assets.length, expenses.length);
    	for (let i = 0; i < maxRows; i++) {
  	    const asset = assets[i] || {};
	    const exp = expenses[i] || {};
	    if (asset.name) doc.text(asset.name, 10, y);
	    if (asset.amount) doc.text(`$${asset.amount.toFixed(2)}`, 60, y, { align: "right" });
	    if (exp.name) doc.text(exp.name, 110, y);
	    if (exp.amount) doc.text(`$${exp.amount.toFixed(2)}`, 160, y, { align: "right" });
	    y += 6;
    }

    doc.setFont(undefined, "bold");
    doc.text("TOTAL ASSETS", 10, y);
    doc.text(`$${totalAssets.toFixed(2)}`, 60, y, { align: "right" });
    doc.text("TOTAL EXPENSES", 110, y);
    doc.text(`$${totalExpenses.toFixed(2)}`, 160, y, { align: "right" });

    doc.save("balance_sheet.pdf");
}

function generateIncomeStatement() {
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text("Income Statement", 10, 10);
    let y = 20;

    let revenue = 0, cogs = 0, operating = 0, nonoperating = 0;

    doc.text("INCOME", 10, y); y += 8;
    journalEntries.forEach(entry => {
    	entry.entries.forEach(tx => {
        	if (tx.accountType === "revenue") {
        	doc.text(tx.accountName, 10, y);
        	doc.text(`$${tx.credit.toFixed(2)}`, 80, y, { align: "right" });
       		revenue += tx.credit;
      		y += 6;
        }
    	});
    });

    doc.setFont(undefined, "bold");
    doc.text("TOTAL REVENUE:", 10, y);
    doc.text(`$${revenue.toFixed(2)}`, 80, y, { align: "right" });
    y += 10;

	doc.setFont(undefined, "normal");
    doc.text("COST OF GOODS SOLD", 10, y); y += 8;
    // Optional: filter specific expense names
    doc.text("COGS Placeholder", 10, y);
    doc.text("$0.00", 80, y, { align: "right" });
    y += 8;
    doc.setFont(undefined, "bold");
    doc.text("GROSS PROFIT:", 10, y);
    doc.text(`$${revenue.toFixed(2)}`, 80, y, { align: "right" });
    y += 10;

    doc.setFont(undefined, "normal");
    doc.text("OPERATING EXPENSES", 10, y); y += 8;
    journalEntries.forEach(entry => {
  		entry.entries.forEach(tx => {
    		if (tx.accountType === "expense") {
		    doc.text(tx.accountName, 10, y);
		    doc.text(`$${tx.debit.toFixed(2)}`, 80, y, { align: "right" });
		    operating += tx.debit;
		    y += 6;
		}
    	});
	});

    doc.setFont(undefined, "bold");
    doc.text("TOTAL EXPENSES:", 10, y);
    doc.text(`$${operating.toFixed(2)}`, 80, y, { align: "right" });
    y += 10;

    const net = revenue - operating;
  		doc.text("NET INCOME:", 10, y);
	    doc.text(`$${net.toFixed(2)}`, 80, y, { align: "right" });

    doc.save("income_statement.pdf");
}

function generateCashFlowStatement() {
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Cash Flow Statement", 10, 10);
  let y = 20;

  let op = 0, inv = 0, fin = 0;

  doc.text("Operating Activities", 10, y); y += 8;
  journalEntries.forEach(entry => {
    entry.entries.forEach(tx => {
      if (tx.accountType === "expense") {
        op -= tx.debit;
        doc.text(tx.accountName, 10, y);
        doc.text(`($${tx.debit.toFixed(2)})`, 80, y);
        y += 6;
      }
    });
  });

  y += 4;
  doc.text("Investing Activities", 10, y); y += 8;
  journalEntries.forEach(entry => {
    entry.entries.forEach(tx => {
      if (tx.accountType === "asset") {
        inv -= tx.debit;
        doc.text(tx.accountName, 10, y);
        doc.text(`($${tx.debit.toFixed(2)})`, 80, y);
        y += 6;
      }
    });
  });

  y += 4;
  doc.text("Financing Activities", 10, y); y += 8;
  journalEntries.forEach(entry => {
    entry.entries.forEach(tx => {
      if (tx.accountType === "liability") {
        fin += tx.credit;
        doc.text(tx.accountName, 10, y);
        doc.text(`$${tx.credit.toFixed(2)}`, 80, y);
        y += 6;
      }
    });
  });

  y += 10;
  doc.setFont(undefined, "bold");
  doc.text("Net Change in Cash:", 10, y);
  doc.text(`$${(op + inv + fin).toFixed(2)}`, 80, y);

  doc.save("cash_flow_statement.pdf");
}

function generateOwnersEquity() {
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Owner's Equity Statement", 10, 10);

  let capital = 0, retained = 0, drawings = 0;

  journalEntries.forEach(entry => {
    entry.entries.forEach(tx => {
      if (tx.accountType === "equity") {
        if (tx.credit > 0) capital += tx.credit;
        if (tx.debit > 0) drawings += tx.debit;
      }
      if (tx.accountType === "revenue") retained += tx.credit;
      if (tx.accountType === "expense") retained -= tx.debit;
    });
  });

  const total = capital + retained - drawings;
  let y = 20;
  doc.text("Capital", 10, y); doc.text(`$${capital.toFixed(2)}`, 60, y); y += 8;
  doc.text("Retained Earnings", 10, y); doc.text(`$${retained.toFixed(2)}`, 60, y); y += 8;
  doc.text("Drawings", 10, y); doc.text(`($${drawings.toFixed(2)})`, 60, y); y += 8;

  doc.setFont(undefined, "bold");
  doc.text("Total Equity", 10, y); doc.text(`$${total.toFixed(2)}`, 60, y);

  doc.save("owners_equity.pdf");
}

document.getElementById("journalForm").addEventListener("submit", function (event) {
	event.preventDefault();
	
	const account1Type = document.getElementById("account1Type").value;
	const account1Name = document.getElementById("account1Name").value;
	const debitAmount1 = parseFloat(document.getElementById("debitAmount1").value) || 0;
	const creditAmount1 = parseFloat(document.getElementById("creditAmount1").value) || 0;
	
	const account2Type = document.getElementById("account2Type").value;
	const account2Name = document.getElementById("account2Name").value;
	const debitAmount2 = parseFloat(document.getElementById("debitAmount2").value) || 0;
	const creditAmount2 = parseFloat(document.getElementById("creditAmount2").value) || 0;
	
	const description = document.getElementById("description").value;
	const postDate = document.getElementById("postDate").value;
	
	if (!account1Type || !account1Name || (!debitAmount1 && !creditAmount1) ||
		!account2Type || !account2Name || (!debitAmount2 && !creditAmount2) ||
		!description || !postDate) {
		alert("Please fill all required fields.");
	return;
		}
		
		const journalNumber = generateJournalNumber(account1Name, account2Name);
		
		const entry = {
			id: Date.now(),description,
				entries: [
					{ accountType: account1Type, accountName: account1Name, debit: debitAmount1, credit: creditAmount1 },
					{ accountType: account2Type, accountName: account2Name, debit: debitAmount2, credit: creditAmount2 }
				],
					journalNumber,
					postDate,														
		};
		
		journalEntries.push(entry);
		localStorage.setItem("journalEntries", JSON.stringify(journalEntries));
		displayJournalEntries();
		updateBalanceStatus();
		document.getElementById("journalForm").reset();
		
		// Reset all dynamic fields
		document.getElementById("asset-details").style.display = "none";
		document.getElementById("prepaid-details").style.display = "none";
		document.getElementById("accrual-details").style.display = "none";
});

document.getElementById("apply-depreciation").addEventListener("change", function () {
	document.getElementById("asset-details").style.display = this.checked ? "block" : "none";
});

document.getElementById("isPrepaid").addEventListener("change", function () {
	document.getElementById("prepaid-details").style.display = this.checked ? "block" : "none";
});

document.getElementById("isAccrued").addEventListener("change", function () {
	document.getElementById("accrual-details").style.display = this.checked ? "block" : "none";
});
</script>

<!-- Optional: AutoGAAP hook -->
<script src="AutoGAAP.js"></script>
<script>
if (typeof runAutoGAAP === "function") {
	console.log("‚úÖ AutoGAAP loaded. You can run runAutoGAAP() to trigger compliance scan.");
}
</script>
</html>
